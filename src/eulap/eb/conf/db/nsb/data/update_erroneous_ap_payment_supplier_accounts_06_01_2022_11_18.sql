
-- Description:	An update script that will update erroneous AP payment supplier accounts vs AP invoice supplier accounts

DROP TABLE IF EXISTS TMP_TBL;

CREATE TABLE TMP_TBL
SELECT APP.AP_PAYMENT_ID, API.SUPPLIER_ACCOUNT_ID AS CORRECT_SA_ID, APP.SUPPLIER_ACCOUNT_ID AS APP_SA_ID
FROM AP_PAYMENT_LINE APPL
INNER JOIN OBJECT_TO_OBJECT OTO ON OTO.TO_OBJECT_ID = APPL.EB_OBJECT_ID
INNER JOIN AP_INVOICE API ON API.EB_OBJECT_ID = OTO.FROM_OBJECT_ID
INNER JOIN AP_PAYMENT APP ON APP.AP_PAYMENT_ID = APPL.AP_PAYMENT_ID
INNER JOIN FORM_WORKFLOW FW ON FW.FORM_WORKFLOW_ID = APP.FORM_WORKFLOW_ID
WHERE OTO.OR_TYPE_ID = 24004
AND FW.CURRENT_STATUS_ID != 4
AND API.SUPPLIER_ACCOUNT_ID != APP.SUPPLIER_ACCOUNT_ID
AND APP.AP_PAYMENT_ID != 624
GROUP BY APP.AP_PAYMENT_ID;

UPDATE AP_PAYMENT APP
INNER JOIN TMP_TBL TT ON TT.AP_PAYMENT_ID = APP.AP_PAYMENT_ID
SET APP.SUPPLIER_ACCOUNT_ID = TT.CORRECT_SA_ID;

DROP TABLE IF EXISTS TMP_TBL;